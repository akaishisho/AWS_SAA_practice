#第3章 ネットワーキングとコンテンツ配信

##3-1 CloudFront
- Amazon CloudFrontは、HTMLファイルやCSS、画像、動画といった静的コンテンツをキャッシュし、オリジンサーバーの代わりに配信するCDN(Contents Delivery Network)サービス
- CloudFrontを使うことで、サーバーの負荷を下げながら安定したサービス提供ができる

### CloudFrontのバックエンド
- CloudFrontはCDNであるため、元となるコンテンツを保持するバックエンドサーバー(オリジンサーバー)が必要
- オリジンサーバーとしては、ELB、EC2、そしてS3の静的ホスティングを利用することができる
- オンプレミスのサーバーを指定することも可能
- URLのパスに応じて異なるオリジンサーバーを指定することで1つのドメインで複数のサービスを提供できる
- そのため、ドメイン名の統一など、企業のWebガバナンス戦略にも役立つ

### ディストリビューション
- CloudFrontには、配信するコンテンツ内容によって異なる2つのディストリビューションがある
  - ダウンロードディストリビューション
    - HTTPやHTTPSを使ってHTMLやCSS、画像などのデータを配信する際に利用
  - ストリーミングディストリビューション
    - RTMP(Real Time Messaging Protocol)を使って動画のストリーミング配信をする際に利用
    - RTMPは2020年12月31日以降は非推奨になる

### キャッシュルール
- CloudFrontでは、拡張子やURLパスごとにキャッシュ期間を指定することができる
- 頻繁にアップデートされる静的コンテンツ(HTMLなど)はキャッシュ期間を短くし、あまり変更されないコンテンツ(画像・動画)は長くするといった設定が可能
- CDNはキャッシュの扱いが重要になるため、キャッシュの強制的な解除運用なども含めて、必要なキャッシュが適切に使われるようにすること

##3-2 Route53
- Amazon Route53はドメイン管理機能と権威DNS機能を持つサービス
- Route53は単にドメインやDNS情報を管理するだけでなく、ネットワークトラフィックのルーティングや接続先のシステムに応じた接続先の変更など、オプション機能も持っている

### ドメイン管理
- Route53で新規ドメインの取得や更新などの手続きが可能
- ドメインの取得からゾーン情報の設定まで、Route53で一貫した管理が可能になる

### 権威DNS
- DNSとは、ドメイン名とIPアドレスを変換(名前解決)するシステム
- 権威DNSとは、ドメイン名とIPアドレスの変換情報を保持しているDNSのことで、変換情報を保持していないDNS(キャッシュDNS)と区別するときに使う

### ホストゾーンとレコード情報
- ホストゾーン
  - レコード情報の管理単位を表す
  - 通常はドメイン名
  - レコード情報は、「www.example.comはIPアドレスが192.168.0.100である」といった、ドメイン(またはサブドメイン)名とIPアドレスを変換するための情報
  - レコード情報にはAレコード、MXレコード、CNAMEレコードといった種類がある
  - Route53で特徴的なレコードとしてAliasレコードがある
    - Aliasレコードは、レコード情報に登録する値として、CloudFrontやELB、S3などのAWSリソースFQDNを指定できる
    - Zone Apexも登録できる
      - Zone Apexとは、最上位ドメイン(Route53の場合はホストゾーン名)のこと

### トラフィックルーティング
- Route53にゾーン情報を登録する際、名前解決の問い合わせに対してどのように応答するかを決める７種類のルーティングポリシーがある
  - シンプルルーティングポリシー
    - 特殊なルーティングポリシーを使わない標準的な1対1のルーティング
  - フェイルオーバールーティングポリシー
    - アクティブ/スタンバイ方式で、アクティブ側のシステムへのヘルスチェックが失敗したときにスタンバイ側のシステムへルーティングするポリシー
  - 位置情報ルーティングポリシー
    - ユーザーの位置情報に基づいてトラフィックをルーティングする際に使用する
  - 地理的近接性ルーティングポリシー
    - リソースの場所に基づいてトラフィックをルーティングし、必要に応じてトラフィックをある場所のリソースから別の場所のリソースに移動する際に使用
    - トラフィックフローを前提とする
  - レイテンシールーティングポリシー
    - 複数箇所にサーバーが分散されて配置されている場合に、遅延が最も少ないサーバーにリクエストをルーティングする
  - 複数値回答ルーティングポリシー
    - 1つのレコードに異なるIPアドレスを複数登録して、ランダムに返却されたIPアドレスに接続する
    - ヘルスチェックがNGになったIPアドレスは返却されないため、正常に稼働しているサーバーに対してのみアクセスを分散させることが可能
  - 加重ルーティングポリシー
    - 指定した比率で複数のリソースにトラフィックをルーティングする際に使用
    - 拠点をまたがってリソースの異なるサーバーが配置されている場合にリクエスト比率を調整する、といったことが可能
    - ABテストのために新サービスをリリースしたサーバーに一定割合のユーザーを誘導したい、といった場合も使用できる

### トラフィックフロー
- ルーティングポリシーを組み合わせることで様々なルーティング環境を構築することができるが、各レコード間の設定が複雑になることがある
- トラフィックフローはそれらの組合せをビジュアル的に分かりやすく組み合わせるためのツールを使って定義できる

### DNSフェイルオーバー
- Route53が持つフォールトトレラントアーキテクチャ
  - フォールトトレラントアーキテクチャ
    - システムに異常が発生した場合でも被害を最小限度に抑えるための仕組みのこと
- ヘルスチェックの結果により発動する
- Route53には3種類のヘルスチェックの種類がある
  - https://docs.aws.amazon.com/ja_jp/Route53/latest/DeveloperGuide/health-checks-types.html
