#第2章　グローバルインフラストラクチャとネットワーク

##2-1 リージョンとアベイラビリティゾーン
- リージョンとは？
  - AWSがサービスを提供している拠点(国と地域)のことを指す
  - リージョン内には複数のアベイラビリティゾーン（AZ）が含まれ、1つのAZは複数のデータセンターから構成される
  - 複数のデータセンターがAZを構成し、複数のAZが集まったものがリージョンとなる

- AZの地理的・電源的独立による信頼性の向上
  - 地理的独立
    - それぞれのAZは、地理的・電源的に独立された場所に配置される
    - 地理的な独立により、災害によるAZのへの局所的な障害に対して、別のAZが影響されないように配置されている
    - AZ間は数十キロ程度離れて配置されているようだが、各AZ間は高速なネットワーク回線で接続されている
    - そのため、ネットワーク遅延の問題が発生することはほとんどなく、AZ間のネットワーク遅延(レイテンシー)は、2ミリ秒以下で安定していることが多い
  - 電源的独立
    - 電源の系統の分離のことで、1ヶ所の停電によりAZ内のすべてのデータセンターが一斉にダウンすることがないように設計されている
  - AZの地理的・電源的独立により、リージョン全体で見たときに、AWSは障害への耐久性が高くなり信頼性が高いと言える

- マルチAZによる可用性の向上
  - 耐障害性を高めシステムの可用性を高めるには、複数のAZを利用してシステムを構築する必要がある
  - AWSでは、これをマルチAZと呼ぶ
  - EC2といった仮想サーバーやデータベースサービスであるRDSなど、インスタンスをベースとしたサービスは、可用性を高める際はマルチAZに冗長的に配置するのが基本

##2-2 VPC
- AWSのネットワークサービスの中心はAmazon Virtual Private Cloud(VPC)
- 利用者ごとのプライベートなネットワークをAWS内に作成する
- インターネットゲートウェイ(IGW)と呼ばれるインターネット側の出口をつけることにより、直接インターネットに出ていくことができる
- オンプレミスの各拠点を繋げるために仮想プライベートゲートウェイ(VGW)を出口として、専用線のサービスであるDirect ConnectやVPN経由で直接的にインターネットに出ずに、各拠点と接続も可能

## IPアドレス
- VPCには、作成が自由なIPアドレス(CIDRブロック)をアサインすることができる
- CIDRブロックは/16から/28の範囲で作成できる
- ネットワーク空間は可能な限り大きなサイズ(/16)で作成すること(後から拡張する方法はあるが、難しいため)
- IPアドレスとしては、クラスA(10.0.0.0 ~ 10.255.255.255)、クラスB(172.16.0.0 ~ 172.31.255.255)、クラスC(192.168.0.0 ~ 192.168.255.255)が使える
- クラスAの場合でも、/8でCIDRブロックは取ることができず、/16でなければならない

## サブネット
- サブネットとは？
  - EC2インスタンスなどを起動するための、VPC内部に作るアドレスレンジ
  - 個々のサブネットには1つの仮想のルーターがあり、このルーターがルートテーブルとネットワークACLの設定を持ち、サブネット内のEC2インスタンスのデフォルトゲートウェイになる
  - サブネットに設定するCIDRブロックのサイズはVPCと同様に16ビット(65536個)から28ビット(16個)まで
  - サブネット作成時にアベイラビリティゾーンを指定する、作成後は変更できない
  - サブネットごとにルートテーブルを1つだけ指定する(作成時はメインルートテーブルが自動的にアサインされ、いつでも異なるルートテーブルに変更可能)
  - サブネットごとにネットワークACLを1つだけ指定する(作成時はデフォルトネットワークACLが自動的にアサインされ、いつでも異なるネットワークACLに変更可能)
  - 1つのVPCに作れるサブネットの数は200個。リクエストにより、拡張可能
- サブネット作成の注意事項
  - サブネットの最初の4つおよび最後の1つのアドレスは予約されていて、使用できない(24ビットマスクのサブネットの場合「0,1,2,3,255」の5つ)
  - 必要以上にサブネットで分割することはアドレスの浪費に繋がる
  - サービスの中にはIPアドレスの確保が必要なサービスがある(ELBの場合はIPアドレスが8個)

## サブネットとAZ
- サブネット作成時のポイントは、同一の役割を持ったサブネットを複数のAZにそれぞれ作ること
- EC2やRDSの作成時にAZをまたいで構築することで、AZ障害に対して耐久性の高い設計にすることができる
- この構成はマルチAZと呼ばれ、AWSにおける設計の基本

## ルートテーブル
- 各々のサブネットに1つずつ設定
- 1つのルートテーブルを複数のサブネットで共有することはできるが、1つのサブネットに複数のルートテーブルを適用することはできない
- 宛先アドレスとターゲットとなるゲートウェイ(ネクストホップ)を指定する
- VPCにはメインルートテーブルがあり、サブネット作成時に指定しない場合のデフォルトのルートテーブルになる

## セキュリティグループとネットワークACL
- VPCの通信制御は、セキュリティーグループとネットワークACL(NACL)を利用して行う
  - セキュリティグループ
    - EC2やELB、RDSなど、インスタンス単位の通信制御に利用
    - 通信の制御としては、インバウンド(内向き、外部からVPCへ)とアウトバンド(外向き、内部から外部へ)の両方の制御が可能
    - 制御項目としては、プロトコル(TCPやUDPなど)とポート範囲、送受信先のCIDRかセキュリティーグループを指定
  - ネットワークACL(アクセスコントロールリスト)
    - サブネット毎の通信制御に利用
    - 制御できる項目はセキュリティグループと同様で、インバウンド/アウトバンドの制御が可能
    - 送受信先のCIDRとポートを指定できるが、セキュリティグループと違い、送受信先にはセキュリティーグループの指定はできない
    - デフォルトの状態ではすべての通信を許可
  - セキュリティグループとネットワークACLの違い
    - 状態(ステート)を保持するかどうか
    - セキュリティーグループはステートフルで、応答トラフィックはルールに関係なく通信が許可される
    - ネットワークACLはステートレスで、応答トラフィックであろうと明示的に許可設定しないと通信遮断される

## ゲートウェイ
- VPCの内部と外部との通信をやり取りする出入り口
- インターネットゲートウェイや仮想プライベートゲートウェイなどがある
  - インターネットゲートウェイ
    - VPCとインターネットとを接続するためのゲートウェイ
    - 各VPCに1つだけアタッチすることができる
    - 論理的には1つしか見えないため、可用性の観点で単一障害点(SPOF)になると懸念されるが、IGWはAWSによるマネージドなサービスであり、冗長化や障害時の復旧が自動的になされる
    - パブリックサブネットの条件の1つは、ルーティングでインターネットゲートウェイに向いていること
    - プライベートサブネットは、ルーティングが直接インターネットゲートウェイに向いていないネットワークになる
    - NATゲートウェイはネットワークアドレス変換機能を有し、プライベートIPをNATゲートウェイが持つグローバルIPに変換し、外部と通信する
    - NATゲートウェイはAZに依存するサービスなので、マルチAZ構成をする場合は、AZごとに作成する必要がある
  - 仮想プライベートゲートウェイ
    - VPCがVPNやDirect Connectと接続するためのゲートウェイ
    - VGWも各VPCに1つだけアタッチすることができる
    - 1つだけしか存在できないが、複数のVPNやDirect Connectと接続が可能

## VPCエンドポイント
- VPCエンドポイントには、S3やDynamoDBと接続する際に利用するゲートウェイエンドポイントと、それ以外の大多数のサービスで利用するインターフェイスエンドポイント(AWS PrivateLink)がある
- ゲートウェイエンドポイントは、ルーティングを利用したサービス
- エンドポイントを作成しサブネットを関連づけると、そのサブネットからS3、DynamoDBへの通信はインターネットゲートウェイではなく、エンドポイントを通じて行われる
- セキュリティの観点でVPCエンドポイントは重要

## ピアリング接続
- VPCピアリングは、2つのVPC間でプライベートな接続をするための機能
- 同一AWSアカウントのVPC間のみならず、AWSアカウントをまたがっての接続も可能
- 通信相手は、VPC内のEC2インスタンスなどであり、IGWやVGWなどにトランジットはできない

## VPCフローログ
- VPC内の通信の解析には、VPCフローログ(VPC Flow Logs)を利用して行う
- AWSでの仮想ネットワークインターフェイスカードであるENI(Elastic Network Interface)単位で記録される
- 記録される内容は、送信元・送信先アドレスとポート、プロトコル番号、データ量と許可/拒否の区別

## Direct ConnectとDirect Connect Gateway
- AWSとオフィスやデータセンターなどの物理拠点と専用線で繋げたい場合は、AWS Direct Connectを利用
- VPNに比べて、遅延やパケット損失率が低下し、スループットが向上するなどのメリット
- Direct Connect Gatewayを利用すると、1つのDirect Connect接続で複数のAWSアカウントやVPCに接続することができる
- 複数のVPCとオンプレミスネットワークを中央ハブを介して接続するAWS Transit Gatewayというサービスもある