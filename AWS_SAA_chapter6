#第6章 ストレージサービス

##6-1 AWSのストレージサービス
- IoTやビッグデータ、機械学習などのIT技術の革新に伴い、データ量の増加やデータの取り扱い方法の多様化が進んでいる
- それに応じて、ストレージにも様々な種類が登場している

###ストレージサービスの分類とストレージのタイプ
- AWSが提供するストレージサービスは以下の5つ、AWSドキュメントの分類ではAWS Snowballもストレージサービスに分類されるが、詳細は割愛
- Snowballは、ペタバイトを超えるような大容量のデータをAWSへ移行したり、AWSから持ち出したりするときに使用するデータ転送サービス
  - Amazon EBS
  - Amazon EFS
  - Amazon S3
  - Amazon S3 Glacier
  - AWS Storage Gateway
- 上記以外にもファイルサーバーのサービスとしてAmazon Fsxがある
- ストレージサービスは一般的に次の3つのタイプに分類できる
  - ブロックストレージ
    - データを物理的なディスクにブロック単位で管理するストレージ
    - データベースや仮想サーバーのイメージ保存領域のように、頻繁に更新されたり高速なアクセスが必要とされる用途で使われる
    - Amazon EBSがブロックストレージのサービス
  - ファイルストレージ
    - ブロックストレージ上にファイルシステムを構成して、データをファイル単位で管理するストレージ
    - 複数のクライアントからネットワーク経由でファイルにアクセスするといったデータ共有のために使われたり、過去データをまとめて保存したりといった用途で使われる
    - Amazon EFSがファイルストレージのサービス
  - オブジェクトストレージ
    - ファイルに任意のメタデータを追加してオブジェクトとして管理するストレージ
    - ファイルの内容をストレージ内で直接操作することはできず、作成済みのデータに対するHTTP(S)経由の登録・削除・参照といった操作が可能
    - 更新頻度の少ないデータや大容量のマルチメディアコンテンツを保存する用途で使われる
    - Amazon S3とAmazon S3 Glacierがオブジェクトストレージのサービス
    - オブジェクトストレージはクラウドの進展とともに注目されている比較的新しいストレージサービス

##6-2 EBS
- Amazon EBSはAWSが提供するブロックストレージサービス(EBSとは、Elastic Block Storeの略)
- EC2のOS領域、EC2の追加ボリューム、RDSのデータ保存領域などに使用する
- EBSは基本的にはEC2に1対1に対応するサービスのため、複数のEC2インスタンスから同時にアタッチするといった使い方はできなかった
- EBSマルチアタック機能により複数のEC2から同時にアタッチ可能となったが、制約が多いため、使い方も限定的
- EBSは作成時にAZを指定するため、指定したAZに作成されたEC2インスタンスからのみアタッチ可能
- 異なるAZのEC2インスタンスにアタッチしたい場合は、EBSのスナップショットを取得し、スナップショットから指定のAZでEBSボリュームを作成することでアタッチ可能となる

###EBSのボリュームタイプ
- EBSのボリュームタイプはSSDで2種類、HDDタイプで2種類の計4つ
  - 汎用SSD(gp2)
  - プロビジョンドIOPS SSD(io1)
  - スループット最適化HDD(st1)
  - Cold HDD(sc1)
- 旧世代のマグネティックと呼ばれるHDDのストレージタイプもあるが、新規で作成するときはマグネティックタイプは使わずに、現行のボリュームタイプから最適なものを選ぶ

###汎用SSD(gp2)
- EBSの中で最も一般的な、SSDをベースとしたボリュームタイプ
- EC2インスタンスを作成する際のデフォルトボリュームタイプとしても利用される
- 性能の指標としてIOPS(1秒あたりに処理できるI/Oアクセスの数)を用い、3IOPS/GB(最低100IOPS)から最大16,000IOPS/ボリュームまで、容量に応じたベースライン性能がある
- 一定期間、性能を向上させるバースト機能も用意されている

###プロビジョンドIOPS SSD(io1)
- プロビジョンドIOPSはEBSの中で最も高性能な、SSDをベースとしたボリュームタイプ
- RDSやEC2インスタンスでデータベースサーバーを構成する場合など、高いIOPS性能が求められる際に利用される
- IOPS負荷の高いユースケースと、高いスループットが必要なユースケースの両方に適したストレージタイプ

###スループット最適化HDD(st1)
- HDDをベースとしたスループット重視のボリュームタイプ
- ログデータに対する処理やバッチ処理のインプット用ファイルなど、大容量ファイルを高速に読み取るようなユースケースに適している

###Cold HDD(sc1)
- 4つのストレージタイプの中でストレージとしての性能はそれほど高くはないが、最も低コストなボリュームタイプ
- 利用頻度があまりなく、アクセス時の性能もそれほど求められないデータをシーケンシャルにアクセスするようなユースケースやアーカイブ領域の用途に適している

###ベースライン性能とバースト性能
- プロビジョンドIOPS以外のストレージタイプには、ストレージの容量に応じてベースライン性能がある
- 処理量の一時的な増加に対応可能なバースト性能という指標もある
- バースト性能は一時的な処理量の増加に対して使われることを想定したものであるため、バースト性能に頼ったサイジングはしてはいけない

###EBSの拡張・変更
- EBSボリュームに対して変更作業を行った場合、同一のEBSボリュームの変更作業は6時間以上あける必要がある
- 現行世代以外のEC2インスタンスタイプで使用中のEBSボリュームに対する変更作業では、インスタンスの停止やEBSのデタッチが必要になる場合がある

###容量拡張
- すべてのタイプのEBSは1ボリュームあたりの最大容量が16TB
- ディスク容量が不足したら、必要に応じて何度でも拡張可能
- オンラインで使用中のEBSボリュームを拡張した後は、EC2インスタンス上でOSに応じたファイルシステムの拡張作業を別途実施して、OS側でも認識できるようにしておくこと
- 縮小はできない

###ボリュームタイプの変更
- 現行世代タイプ間でのタイプ変更が可能
- gp2タイプで作成したがIOPSが不足することが分かったので、io1タイプに変更したいといった要件に対応可能
- プロビジョンドIOPSタイプで指定したIOPS値については、増減のどちらの変更も可能
- IOPSの変更には最大24時間かかる場合がある

###EBSの可用性・耐久性
- EBSは内部的にAZ内の複数の物理ディスクに複製が行われており、AWS内で物理的な故障が発生した場合でも、利用者が意識することはほとんどない
- EBSにはスナップショット機能もあるため、定期的にバックアップを取得することで必要な時点に戻すことが可能
- データのリストアは、スナップショットから新規EBSボリュームを作成し、EC2インスタンスにアタッチすることで可能
- 信頼性は高いが壊れない訳ではないので、スナップショットなどでバックアップをとる運用設計の検討は必要

###EBSのセキュリティ
- ストレージ自体を暗号化するオプションがある
- 暗号化オプションを有効にすると、ボリュームだけでなく、ボリュームから取得したスナップショットも暗号化される
- 暗号化処理はEC2インスタンスが稼働するホストで実施されるので、EBS間をまたぐデータ通信時のデータも暗号化された状態になる
- 既に作成済みのEBSボリュームを暗号化した場合
  - EBSボリュームのスナップショットを取得 → スナップショットを暗号化 → 暗号化されたスナップショットから新規EBSボリュームを作成 → EC2インスタンスにアタッチしているEBSボリュームを入れ替え
- 既存のブートボリュームを暗号化する場合は、スナップショットではなくAMIを取得し、AMIコピー時に暗号化をし、コピーされたAMIからEC2インスタンスを作成することで可能

###Amazon EBSマルチアタッチ
- 制約は多いが、今まで実現できなかった複数のインスタンスから同一のEBSをアタッチできる機能
- 同一のAZのインスタンスから飲みアタッチ可能で、別AZからはできない
- プロビジョンドIOPS SSD(io1)ボリュームのみ利用可能

##6-3 EFS
- Amazon EFSは、容量無制限で複数のEC2インスタンスから同時にアクセスが可能なファイルストレージサービス(EFSとは、Elastic File Systemの略)
- クライアントからEFSへの接続は、一般的なNFS(Network File System)プロトコルをサポートしているため、NFSクライアントさえあれば特別なツールや設定は不要
- amazon-efs-utilsツールを使うと、EFSへのマウントに関する推奨オプションが含まれていたり、ログが記録できたりするため、EFSへ接続するクライアントには導入する方が良い
- EFSには多種多様なユースケースに対応できるように、パフォーマンスモードやスループットモードといったモードが用意されている

###EFSの構成要素
- EFSは以下の3つの要素から構成される
  - ファイルシステム
  - マウントターゲット
  - セキュリティグループ
- ファイルが作成されると自動的に3ヶ所以上のAZに保存される分散ファイルシステムを構成
- 作成したファイルシステムにアクセスするために、AZごとにサブネットを指定してマウントターゲットを作成する
- マウントターゲットを作成すると、ターゲットポイント(接続FQDN)が1つと各AZのマウントターゲット用IPアドレスが発行される
- EC2からは1つのFQDNでアクセスするが内部的には自動的に接続元のEC2インスタンスと同一AZのマウントターゲットIPアドレスが返却されるため、レイテンシーを低くする設計がされている
- マウントターゲットにはセキュリティグループを指定でき、不要なアクセスを制限できる

###EFSのパフォーマンスモード
- 汎用パフォーマンスモードと最大I/Oパフォーマンスモードの2つパフォーマンスモードがある
- ほとんどの場合は、汎用パフォーマンスモードを使えば問題なし
- 数百〜数千台といったクライアントから同時にEFSへアクセスがあるようなユースケースにも耐えられるように、最大I/Oパフォーマンスモードが用意されている
- 最大I/Oパフォーマンスモードを選択した場合、スループットを最大化する代わりに、各ファイル操作のレイテンシーが汎用パフォーマンスモードより少し高くなる
- どちらが良いか見分ける指標として、CloudWatchのPercentIOLimitというメトリクスが参考になる
- 性能テスト実施中にPercentIOLimitが長時間高い状態(80〜100％)である場合は、最大I/Oパフォーマンスモードに変更した方がよい場合もある
- パフォーマンスモードはファイルシステムを一度作成すると変更できないため、本番導入前に入念にテストを実施して検討すること

###EFSのスループットモード
- パフォーマンスモードとは別に2つのスループットモードが用意されている
  - バーストスループットモード
    - EFSに保存されているデータ容量に応じてベースラインとなるスループットが設定されている
    - 一時的なスループットの上昇にも耐えられるようなバースト機能を持ったモード
    - ベースラインのスループットは1GBあたり50KB/秒、保存されているデータ量に応じてスループットと期間が設定される
    - 最低バーストスループットは100MB/秒
    - 1TBを超えると、毎日12時間、ストレージの1TBあたり100MB/秒までバーストできるバーストクレジットが貯まるように設計される
  - プロビジョニングスループットモード
    - バーストスループットモードで設定されているベースラインスループットを大幅に上回るスループットが必要な場合や、
      一時的なバースト時にバーストスループットで定められている最大スループットよりも高い性能が必要な場合に、任意のスループット値を指定することができるモード
    - 容量によらず最大1GB/秒までのスループットを指定できる
    - それ以上のスループットが必要な場合は制限の緩和申請が可能
    - Web配信用のコンテンツやアプリケーション用のデータといった、データサイズはそれほど大きくないものの頻繁にアクセスしたり、大量のインスタンスからの同時アクセスを受けるようなデータをEFSに配置する場合に最適
  - どちらを選択するべきか見分ける指標として、CloudWatchのBurstCreditBalanceというメトリクスが参考になる
  - クレジットバランスを全て使い切ったり、常に減少傾向である場合はプロビジョニングスループットモードを選択
  - スループットモードはEBS運用中にも変更可能
  - スループットモードの変更、およびプロビジョニングスループットモードでのスループット値の削減は、前回作業から24時間以上間隔をあける必要あり