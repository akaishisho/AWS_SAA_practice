#第5章 運用支援サービス

##5-1 AWSにおける運用支援サービス
- Amazon CloudWatch
  - 定期的にAWSリソースの状態を取得し、問題がある場合はそれを運用者に通知するサービス
  - ミドルウェアやアプリケーションのログを監視する機能や、独自にトリガーを定義し、そのトリガーが発生したら後続の処理を行う機能も提供されている
- AWS CloudTrail
  - AWSリソースの作成や、マネジメントコンソールのログインなどの操作を記録するサービス
  - S3にログを残す機能も提供されているため、そのログをそのまま監査ログにすることができる

##5-2 CloudWatch
- 運用監視を支援するマネージドサービス
- CloudWatchには、中核となる3つの機能と、比較的最近追加された4つの機能がある
  - CloudWatch
  - CloudWatch Logs
  - CloudWatch Events
  - CloudWatch Synthetics
  - CloudWatch ServiceLens
  - Container Insight
  - Contributor Insights

### CloudWatch
- 各AWSリソースの状態を定期的に取得する、この状態のことをメトリクスと呼ぶ
- 具体的には、EC2インスタンスのCPU使用率であったり、Lambda関数ごとのエラー回数などが定義されている
- AWSがあらかじめ定義しているメトリクスを標準メトリクスと呼ぶ
  - https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/CW_Support_For_AWS.html
- 利用者が定義した値をCloudWatchに渡すことで、独自のメトリクスを作成することもできる、これはカスタムメトリクスと呼ばれる
- これらのメトリクスを選択し、アラームを定義することができる
  - 具体例
      - Webサーバー用のEC2インスタンスのCPU率が80％を上回ったとき
      - 定期実行するLambda関数が一定期間に3回以上エラーを出したとき
- このようなアラームの条件を満たしたときに別サービスのSNSに通知するように設定することができる
- システムのよくない状況をすぐに検知する、それがCloudWatchの基本的なユースケースになる

### CloudWatch Logs
- アプリケーションログやApacheログなどのログをモニタリングするサービス
- CloudWatch Logsを利用するには、独自のエージェントをインストールする必要がある
- このエージェントを介して、各EC2インスタンスのログをCloudWatch Logsに収集する
- このとき、送信元のインスタンスにCloudWatchのIAMの権限を付与する必要があるため、IAMロールで設定しておく
- CloudWatch Logsでは、収集したログに対してアラームを設定できる
- アラームをトリガーにしてなにかしらの処理ができるため、アプリケーションレイヤーの監視もでき、システムをより安定して運用することが可能になる

### CloudWatch Events
- 独自のトリガーと何かしらの後続のアクションとの組み合わせを定義するサービス
- 独自のトリガーをイベントソースと呼び、後続のアクションをターゲットと呼ぶ
- AWSの各サービスをシームレスに連携することができる。
- イベントソースには大きく2種類
  - スケジュール
    - 期間・時間ベースのトリガー定義
  - 各AWSリソースのイベント
    - 「Auto Scalingがインスタンスを増減させたら」「CodeBuildの状態が変わったら」といった、AWSリソースの状態変化をトリガーにする
- ターゲットには既存のAWSリソースに対するアクションを定義する
- 1つのイベントソースに対して複数のターゲットを定義することもできる
- CloudWatch Eventsと同じAPIを使い、機能が追加されたEventBridgeが登場している
- 将来的にEventBridgeに統合予定になっている

##5-3 CloudTrail
- AWSに関する操作ログを自動的に取得するサービス
- CloudTrailを利用すると、監査情報を簡単に取得できる

### CloudTrailで取得できるログの種類
- CloudTrailで取得できる操作(イベント)には、管理イベントとデータイベントがある
  - 管理イベント
    - マネジメントコンソールへのログイン、EC2インスタンスの作成、S3のバケット作成など
  - データイベント
    - S3バケット上のデータ操作、Lambda関数の実行など
- 管理イベントの取得のみがデフォルトで有効になっており、過去90日分のログをマネジメントコンソール上で確認できる
- 過去90日以前の情報を保持したい場合は、S3に証跡を残すように設定することも可能

### CloudWatch Logsとの連携
- ユーザーが不正な操作をしたことを自動的に検知したいような場合は、CloudWatch Logsとの連携機能がある
- 事前に不正な操作(のログメッセージ/文字列)を登録しておき、ユーザーがそれに該当する行動をしたときに検知することができる
- それにより、インシデントにつながる操作を早期発見することができる