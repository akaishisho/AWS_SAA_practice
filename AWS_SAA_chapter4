# 第4章 コンピューティングサービス

##4-1 AWSにおけるコンピューティングサービス
- コンピューティングサービスは、アプリケーションを稼働させるインフラストラクチャサービスで、システムアーキテクチャの中核を担う
  - EC2
    - 仮想サーバーを提供するコンピューティングサービス
    - 必要な数だけすぐにサービスを立てられる、IaaS型のサービス
    - Elastic Load Balancing(ELB)やAuto Scalingといったサービスと組み合わせると、負荷に応じて動的にサーバーの台数を変更するクラウドらしい使い方も可能
  - ECS
    - Dockerコンテナの実行環境を提供するサービス
    - AWSでDockerを利用するためには、EC2上にコンテナ管理用のソフトウェアの導入が必要であった
    - ECSはサービスとしてDocker環境を提供してくれるため、設定・構築の項目を減らすことが可能
  - Lambda
    - サーバーを用意しなくてもプログラムを実行できる環境を提供するサービス
    - サーバーレスアーキテクチャの中心と言えるサービスで、拡張性やコスト効率の面でメリットがある

##4-2 EC2
- Amazon Elastic Compute Cloud(EC2)は、インスタンスという単位でサーバーが管理され、簡単に新しいインスタンスを作ることができる
- オンプレミス環境に比べ、サーバー調達のリードタイムを非常に短くできる
- EC2を用いることでインフラリソースを柔軟に最適化することができる
- 事前の見積もりに時間をかけるのでなく、ビジネス的に価値を生む行為に注力できる
- 起動する際には、元となるイメージを選んでインスタンスを作成する、このイメージをAmazon Machine Image(AMI)と呼ぶ
- AMIにはAmazon Linux AMIやRed Hat Enterprise linuxなど、AWSが標準で提供しているものや、各ベンダーがサービスをプリインストールしたAMIがある

### EC2における性能の考え方
- EC2はインスタンスタイプという形で、インスタンスのスペックを選択することができる
- インスタンスタイプは「m5.large」といった形式で表記される、先頭の「m」はインスタンスファミリーを表し、何に最適化しているインスタンスタイプかを意味する
- インスタンスファミリーの後ろの数字は世代を表し、大きいものが最新となる
- 「large」の部分がインスタンスサイズを表し、大きいものほどスペックが高いインスタンスタイプになる
- Amazon EC2 インスタンスタイプ (AWS公式サイト)
  - https://aws.amazon.com/jp/ec2/instance-types
- インスタンスの性能を決める他の需要な要因として、ディスク機能であるEBS(Elastic Block Store)がある
- EBS最適化インスタンス
  - EC2では通常の通信で使用するネットワーク帯域と、EBSとのやり取りで利用する帯域を共有している
  - そのため、ディスクI/O、外部とのリクエストともに多く発生する場合、帯域が足りなくなることがあり、このようなときに利用できるオプション
  - このオプションを有効にすると、通常のネットワーク帯域とは別に、EBS用の帯域が確保される
  - ある程度大きめのインスタンスタイプでしか利用できないため、利用の際は、公式ドキュメントを確認

### EC2における費用の考え方
- EC2はインスタンスを使用した分だけ課金される従量課金型のサービス
- EC2のコストは下記により決まる
  - インスタンスがRunning状態だった時間
  - Running状態だったインスタンスのタイプ、AMI、起動リージョン
- インスタンスには、起動中(Running)、停止中(Stopped)、削除済み(Terminated)の3つの状態がある
- EC2では、起動しているインスタンスのみが課金対象になるため、一時的に停止中ステータスにしたインスタンスや削除したインスタンスは課金対象にならない
- 停止中のインスタンスでもEBSの費用はかかることに注意!!
- 起動しているインスタンスは、インスタンスタイプに応じて課金され、費用はリージョンやインスタンスのAMIによっても異なる

### スポットインスタンスとリザーブドインスタンス
- これまでの記述のEC2の価格は、オンデマンドインスタンスという通常の利用形態の場合のもの
- EC2には、これ以外に、スポットインスタンスとリザーブドインスタンスという利用オプションがある
  - スポットインスタンス
    - AWSが余らせているEC2リソースを入札形式で安く利用する方式
    - 利用リクエストが増え、余剰なリソースがなくなってしまうと、インスタンスが自動的に中断される
    - この制約を許容できる場合、例えば開発用の環境や機械学習のデータ学習のために一時的にスペックの大きいインスタンスを使いたいといった用途であれば、相性が良いオプションと言える
  - リザーブドインスタンス(RI)
    - 長期間の利用を約束することで割引を受けられるオプション
    - サービスをリリースしてからしばらく経ち、インスタンスタイプを固定できると判断できた時点でRIの購入を検討するとよい

### インスタンスの分類と用途
- 分類
  - 汎用
    - 一番利用の範囲が広くCPUとメモリのバランス型、M5やT3などが該当する
  - コンピューティング最適化
    - CPUの性能が高いもの、現状はC5などのC系統のみ
  - メモリ最適化
    - メモリ容量が大きいもの、R5やX1などの複数の系列があるが、一般的な利用でのメインはR系となる
  - 高速コンピューティング
    - GPUなどCPU以外の計算リソースが強化されている
    - かなり細分化されているが、画像処理用のP系と機械学習用のG系を押さえておくとよい
  - ストレージ最適化
    - ストレージ最適化もかなり細分化されているが、HDDを利用するD2とSSDを利用するI3を覚えておくこと

### Savings Plansとスケジュールされたリザーブドインスタンス
- Savings Plans
  - リザーブドインスタンスと比較して、より柔軟な形で割引を享受できるプラン
  - リザーブドインスタンスとの違いは、インスタンスの利用数ではなく、EC2インスタンスの利用額に対してコミットする点
  - Savings Plansには2種類ある
    - EC2 Instance Savings Plans
      - 従来のリザーブドインスタンスと同じようにリージョンやインスタンスファミリーを指定して購入
    - Compute Savings Plans
      - リージョンやインスタンスファミリーと関係なく、全てのEC2インスタンスを対象に単位時間あたりの利用料を指定して購入する
  - スケジュールされたリザーブドインスタンス
    - リザーブドインスタンスの買い方のパターン
    - 1年間のうちに毎日、毎週、毎月の一定時間のみ使うというパターンで、平日日中のみ使うという場合などに利用料を削減できる可能性がある
    - 対象のインスタンスはC3、C4、M4、およびR3
    - https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-scheduled-instances.html